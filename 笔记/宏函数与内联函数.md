# C++ å®å‡½æ•°ä¸å†…è”å‡½æ•°è¯¦è§£

## ç›®å½•
- [å®å‡½æ•° (Macro Functions)](#å®å‡½æ•°-macro-functions)
- [å†…è”å‡½æ•° (Inline Functions)](#å†…è”å‡½æ•°-inline-functions)
- [æ ¸å¿ƒåŒºåˆ«ï¼šäºŒè€…çš„æœ¬è´¨å·®å¼‚](#æ ¸å¿ƒåŒºåˆ«äºŒè€…çš„æœ¬è´¨å·®å¼‚)
- [åœ¨CUDAä¸­çš„åº”ç”¨](#åœ¨cudaä¸­çš„åº”ç”¨)

---

## å®å‡½æ•° (Macro Functions)

### å®šä¹‰ä¸è¯­æ³•

å®å‡½æ•°æ˜¯é€šè¿‡é¢„å¤„ç†å™¨æŒ‡ä»¤ `#define` å®šä¹‰çš„ä»£ç ç‰‡æ®µï¼Œåœ¨ç¼–è¯‘å‰è¿›è¡Œ**æ–‡æœ¬æ›¿æ¢**ã€‚

```cpp
// åŸºæœ¬è¯­æ³•
#define å®å(å‚æ•°åˆ—è¡¨) æ›¿æ¢æ–‡æœ¬

// ç¤ºä¾‹
#define SQUARE(x) ((x) * (x))
#define MAX(a, b) ((a) > (b) ? (a) : (b))
```

### å·¥ä½œåŸç†

**é¢„å¤„ç†å™¨è¿›è¡Œ"ç›²ç›®çš„æ–‡æœ¬æ›¿æ¢"â€”â€”å®ƒä¸æ‡‚C++è¯­ä¹‰ï¼Œåªä¼šå¤åˆ¶ç²˜è´´ï¼š**

```
æºä»£ç  â†’ é¢„å¤„ç†å™¨ï¼ˆæ–‡æœ¬æ›¿æ¢ï¼‰â†’ ç¼–è¯‘å™¨ â†’ å¯æ‰§è¡Œæ–‡ä»¶
            â†‘
         å®åœ¨è¿™é‡Œå±•å¼€
```

```cpp
#define SQUARE(x) ((x) * (x))

int result = SQUARE(a + 1);
// é¢„å¤„ç†å™¨æœºæ¢°æ›¿æ¢ä¸º: int result = ((a + 1) * (a + 1));
```

### å®çš„å¸¸ç”¨æŠ€å·§

#### å­—ç¬¦ä¸²åŒ–æ“ä½œç¬¦ (#)
```cpp
#define TO_STRING(x) #x
#define TRACE(var) printf(#var " = %d\n", var)

int count = 10;
TRACE(count);  // å±•å¼€ä¸º: printf("count" " = %d\n", count);
               // è¾“å‡º: count = 10
```

#### è¿æ¥æ“ä½œç¬¦ (##)
```cpp
#define CONCAT(a, b) a##b
CONCAT(var, 123)  // å±•å¼€ä¸º var123
```

#### å¤šè¡Œå®å’Œ do-while(0)
```cpp
#define FREE_AND_NULL(ptr) \
    do { \
        free(ptr); \
        ptr = NULL; \
    } while(0)
```

> [!TIP]
> ä½¿ç”¨ `do { ... } while(0)` åŒ…è£…å¤šè¯­å¥å®ï¼Œç¡®ä¿åœ¨å„ç§ä¸Šä¸‹æ–‡ï¼ˆå¦‚ifè¯­å¥ï¼‰ä¸­éƒ½èƒ½æ­£ç¡®å·¥ä½œã€‚

### å®çš„ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹ï¼š**
- æ— å‡½æ•°è°ƒç”¨å¼€é”€
- ç±»å‹æ— å…³ï¼ˆå¯ç”¨äºä»»ä½•ç±»å‹ï¼‰
- æ”¯æŒæ¡ä»¶ç¼–è¯‘å’Œå­—ç¬¦ä¸²åŒ–
- `__FILE__`ã€`__LINE__` è·å–è°ƒç”¨ç‚¹ä¿¡æ¯

**ç¼ºç‚¹ï¼š**
- âŒ æ— ç±»å‹æ£€æŸ¥
- âŒ å‚æ•°å¯èƒ½è¢«å¤šæ¬¡æ±‚å€¼ï¼ˆå‰¯ä½œç”¨é—®é¢˜ï¼‰
- âŒ éš¾ä»¥è°ƒè¯•
- âŒ æ— è§†ä½œç”¨åŸŸï¼Œå¯èƒ½å‘½åå†²çª

---

## å†…è”å‡½æ•° (Inline Functions)

### å®šä¹‰ä¸è¯­æ³•

```cpp
inline int square(int x) {
    return x * x;
}
```

### å·¥ä½œåŸç†ï¼šä»€ä¹ˆæ˜¯"æ¯ä¸ªè°ƒç”¨ç‚¹æ’å…¥å‡½æ•°ä½“"ï¼Ÿ

#### æ™®é€šå‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹

```cpp
int square(int x) { return x * x; }

int main() {
    int a = 5;
    int b = square(a);  // å‡½æ•°è°ƒç”¨
}
```

**æ™®é€šå‡½æ•°è°ƒç”¨æ—¶ï¼ŒCPUéœ€è¦ï¼š**
```
1. ä¿å­˜å½“å‰æ‰§è¡Œä½ç½®
2. æŠŠå‚æ•°å‹å…¥æ ˆ
3. è·³è½¬åˆ°squareå‡½æ•°åœ°å€
4. æ‰§è¡Œå‡½æ•°ä½“
5. æŠŠç»“æœæ”¾å…¥è¿”å›å¯„å­˜å™¨
6. è·³è½¬å›è°ƒç”¨ç‚¹
7. æ¢å¤æ‰§è¡Œ

â†’ æœ‰è·³è½¬å¼€é”€ï¼
```

**å¯è§†åŒ–ï¼š**
```
å†…å­˜å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mainå‡½æ•°    â”‚ â”€â”€â”
â”‚  int b =... â”‚   â”‚ è·³è½¬åˆ°square
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â†“
                  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ squareå‡½æ•°  â”‚ â”€â”€â†’ å†è·³è½¬å›æ¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å†…è”å‡½æ•°çš„è¿‡ç¨‹

```cpp
inline int square(int x) { return x * x; }

int main() {
    int a = 5;
    int b = square(a);  // ä¼šè¢«å†…è”
}
```

**ç¼–è¯‘å™¨ç›´æ¥æŠŠå‡½æ•°ä½“"å¤åˆ¶ç²˜è´´"åˆ°è°ƒç”¨ç‚¹ï¼š**

```cpp
// ç¼–è¯‘åç­‰ä»·äºï¼š
int main() {
    int a = 5;
    int b = a * a;  // å‡½æ•°ä»£ç ç›´æ¥åœ¨è¿™é‡Œï¼Œæ— éœ€è·³è½¬ï¼
}
```

**å¯è§†åŒ–ï¼š**
```
å†…å­˜å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mainå‡½æ•°        â”‚
â”‚  int a = 5;     â”‚
â”‚  int b = a * a; â”‚  â† ä»£ç ç›´æ¥åœ¨è¿™é‡Œï¼Œä¸ç”¨è·³è½¬ï¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å†…è”çš„æ„ä¹‰

**å¯¹äºé¢‘ç¹è°ƒç”¨çš„å°å‡½æ•°ï¼Œé¿å…è°ƒç”¨å¼€é”€å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ï¼š**

```cpp
// åœºæ™¯ï¼šåœ¨å¾ªç¯ä¸­é¢‘ç¹è°ƒç”¨å°å‡½æ•°
inline float dot(float3 a, float3 b) {
    return a.x*b.x + a.y*b.y + a.z*b.z;
}

for (int i = 0; i < 1000000; i++) {
    float d = dot(vectors[i], normal);  // 100ä¸‡æ¬¡è°ƒç”¨
}
```

| æ–¹æ¡ˆ | æ¯æ¬¡è°ƒç”¨å¼€é”€ | 100ä¸‡æ¬¡æ€»å¼€é”€ |
|------|-------------|--------------|
| æ™®é€šå‡½æ•° | ~5çº³ç§’è°ƒç”¨ + è®¡ç®— | é¢å¤–5ç§’+ |
| å†…è”å‡½æ•° | ä»…è®¡ç®— | é›¶é¢å¤–å¼€é”€ |

---

## æ ¸å¿ƒåŒºåˆ«ï¼šäºŒè€…çš„æœ¬è´¨å·®å¼‚

> [!IMPORTANT]
> è™½ç„¶å®å’Œå†…è”éƒ½æ˜¯"æŠŠä»£ç å¤åˆ¶åˆ°è°ƒç”¨ç‚¹"ï¼Œä½†å®ç°æ–¹å¼å®Œå…¨ä¸åŒï¼

### åŒºåˆ«1ï¼šæ›¿æ¢æ—¶æœº

| | å® | å†…è”å‡½æ•° |
|---|---|---|
| **ä½•æ—¶å¤„ç†** | é¢„å¤„ç†é˜¶æ®µï¼ˆç¼–è¯‘å‰ï¼‰ | ç¼–è¯‘é˜¶æ®µ |
| **å¤„ç†è€…** | é¢„å¤„ç†å™¨ï¼ˆä¸æ‡‚C++ï¼‰ | ç¼–è¯‘å™¨ï¼ˆæ‡‚C++è¯­ä¹‰ï¼‰ |

### åŒºåˆ«2ï¼šæ–‡æœ¬æ›¿æ¢ vs ä»£ç æ›¿æ¢

**å® = ç›²ç›®çš„æ–‡æœ¬æ›¿æ¢ï¼ˆåƒCtrl+HæŸ¥æ‰¾æ›¿æ¢ï¼‰ï¼š**

```cpp
#define SQUARE(x) ((x) * (x))

int i = 5;
int result = SQUARE(i++);
// é¢„å¤„ç†å™¨æœºæ¢°æ›¿æ¢ä¸º: ((i++) * (i++))
// iè¢«é€’å¢ä¸¤æ¬¡ï¼ç»“æœä¸å¯é¢„æµ‹ï¼
```

**å†…è” = æ™ºèƒ½çš„ä»£ç æ›¿æ¢ï¼ˆç¼–è¯‘å™¨ç†è§£è¯­ä¹‰ï¼‰ï¼š**

```cpp
inline int square(int x) { return x * x; }

int i = 5;
int result = square(i++);
// ç¼–è¯‘å™¨ç†è§£è¿™æ˜¯å‡½æ•°è°ƒç”¨ï¼Œå…ˆè®¡ç®—å‚æ•°ï¼š
// int temp = i++;  // iå˜æˆ6ï¼Œtempæ˜¯5
// int result = temp * temp;  // result = 25
// iåªé€’å¢ä¸€æ¬¡ï¼Œç»“æœæ­£ç¡®ï¼
```

### åŒºåˆ«3ï¼šç±»å‹æ£€æŸ¥

```cpp
// å®ï¼šæ— ç±»å‹æ£€æŸ¥
#define MAX(a, b) ((a) > (b) ? (a) : (b))
MAX("abc", "def");  // ç¼–è¯‘é€šè¿‡ï¼Œä½†æ¯”è¾ƒçš„æ˜¯æŒ‡é’ˆåœ°å€ï¼ğŸ’¥

// å†…è”ï¼šæœ‰ç±»å‹æ£€æŸ¥
inline int max(int a, int b) { return a > b ? a : b; }
max("abc", "def");  // âŒ ç¼–è¯‘é”™è¯¯ï¼šç±»å‹ä¸åŒ¹é…
```

### åŒºåˆ«4ï¼šä½œç”¨åŸŸ

```cpp
// å®ï¼šæ— è§†ä½œç”¨åŸŸï¼Œå…¨å±€æ›¿æ¢
#define SIZE 100
namespace MyNS { int SIZE = 200; }  // âŒ ç¼–è¯‘é”™è¯¯

// å†…è”ï¼šéµå®ˆä½œç”¨åŸŸè§„åˆ™
inline int getSize() { return 100; }
namespace MyNS { inline int getSize() { return 200; } }  // âœ… OK
```

### å½¢è±¡æ¯”å–»

| å®å‡½æ•° | å†…è”å‡½æ•° |
|--------|----------|
| ä¸æ‡‚ä¸­æ–‡çš„å¤–å›½äººå¸®ä½ æ”¹ä½œæ–‡ | æ‡‚ä¸­æ–‡çš„ç¼–è¾‘å¸®ä½ æ”¹ä½œæ–‡ |
| "æŠŠæ‰€æœ‰'ä»–'æ”¹æˆ'å¥¹'" â†’ æœºæ¢°æ›¿æ¢ | "ä¿®æ”¹äººç§°" â†’ ç†è§£è¯­ä¹‰åä¿®æ”¹ |

---

## åœ¨CUDAä¸­çš„åº”ç”¨

### ä¸ºä»€ä¹ˆ CUDA_CHECK å¿…é¡»ç”¨å®ï¼Ÿ

è¿™æ˜¯å®çš„**æ€æ‰‹çº§åº”ç”¨åœºæ™¯**ï¼

#### å…¸å‹çš„CUDAé”™è¯¯æ£€æŸ¥å®

```cpp
#define CUDA_CHECK(call) \
    do { \
        cudaError_t err = call; \
        if (err != cudaSuccess) { \
            fprintf(stderr, "CUDA Error at %s:%d: %s\n", \
                    __FILE__, __LINE__, cudaGetErrorString(err)); \
            exit(EXIT_FAILURE); \
        } \
    } while(0)
```

#### ç”¨å®çš„æ•ˆæœï¼ˆæ­£ç¡®ï¼‰

```cpp
// main.cu
void foo() {
    float* d_data;
    CUDA_CHECK(cudaMalloc(&d_data, 1024));  // ç¬¬23è¡Œ
    CUDA_CHECK(cudaMemcpy(...));             // ç¬¬24è¡Œ
}
```

**ç¬¬23è¡Œçš„å®å±•å¼€ä¸ºï¼š**
```cpp
do {
    cudaError_t err = cudaMalloc(&d_data, 1024);
    if (err != cudaSuccess) {
        fprintf(stderr, "CUDA Error at %s:%d: %s\n",
                "main.cu", 23, cudaGetErrorString(err));
                // â†‘ __FILE__ = "main.cu"
                // â†‘ __LINE__ = 23 (è°ƒç”¨ç‚¹çš„è¡Œå·)
        exit(EXIT_FAILURE);
    }
} while(0)
```

**é”™è¯¯è¾“å‡ºï¼š**
```
CUDA Error at main.cu:23: out of memory
```
âœ… **å‡†ç¡®å®šä½åˆ°å‡ºé”™çš„é‚£ä¸€è¡Œï¼**

#### å¦‚æœç”¨å†…è”å‡½æ•°ï¼ˆé”™è¯¯åšæ³•ï¼‰

```cpp
// cuda_utils.h ç¬¬5è¡Œ
inline void cudaCheck(cudaError_t err) {
    if (err != cudaSuccess) {
        fprintf(stderr, "CUDA Error at %s:%d: %s\n",
                __FILE__, __LINE__, cudaGetErrorString(err));
                // â†‘ __FILE__ = "cuda_utils.h"
                // â†‘ __LINE__ = 5 (å‡½æ•°å®šä¹‰å¤„ï¼Œä¸æ˜¯è°ƒç”¨å¤„ï¼)
        exit(EXIT_FAILURE);
    }
}
```

**é”™è¯¯è¾“å‡ºï¼š**
```
CUDA Error at cuda_utils.h:5: out of memory
CUDA Error at cuda_utils.h:5: invalid argument
```
âŒ **æ‰€æœ‰é”™è¯¯éƒ½æŒ‡å‘åŒä¸€è¡Œï¼Œæ— æ³•å®šä½çœŸæ­£å‡ºé”™çš„ä½ç½®ï¼**

#### ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ

`__FILE__` å’Œ `__LINE__` æ˜¯**é¢„å¤„ç†å™¨å®**ï¼š
- å®å±•å¼€æ—¶ï¼Œ`__FILE__` å’Œ `__LINE__` ä¼šè¢«æ›¿æ¢ä¸º**å®è°ƒç”¨ç‚¹**çš„ä½ç½®
- å†…è”å‡½æ•°ä¸­ï¼Œå®ƒä»¬è¢«æ›¿æ¢ä¸º**å‡½æ•°å®šä¹‰å¤„**çš„ä½ç½®

#### å®çš„å…¶ä»–ç‹¬ç‰¹ä¼˜åŠ¿

**1. å­—ç¬¦ä¸²åŒ–è°ƒç”¨ä»£ç ï¼š**
```cpp
#define CUDA_CHECK(call) \
    /* ... */ \
    fprintf(stderr, "CUDA call '%s' failed\n", #call);

CUDA_CHECK(cudaMalloc(&d_data, 1024));
// è¾“å‡º: CUDA call 'cudaMalloc(&d_data, 1024)' failed
```
âœ… è¿è°ƒç”¨çš„ä»£ç éƒ½æ˜¾ç¤ºå‡ºæ¥äº†ï¼

**2. æ¡ä»¶ç¼–è¯‘å®Œå…¨ç§»é™¤ï¼š**
```cpp
#ifdef DEBUG
    #define CUDA_CHECK(call) /* å®Œæ•´çš„é”™è¯¯æ£€æŸ¥ä»£ç  */
#else
    #define CUDA_CHECK(call) call  // Releaseç‰ˆæœ¬ï¼šé›¶å¼€é”€
#endif
```

---

### CUDAä¸­çš„å†…è”å‡½æ•°

å¯¹äºæ€§èƒ½å…³é”®çš„**è®¡ç®—å‡½æ•°**ï¼Œä½¿ç”¨å†…è”ï¼š

```cpp
// å¼ºåˆ¶å†…è”çš„è®¾å¤‡å‡½æ•°
__device__ __forceinline__ float dot(float3 a, float3 b) {
    return a.x * b.x + a.y * b.y + a.z * b.z;
}

__device__ __forceinline__ float3 cross(float3 a, float3 b) {
    return make_float3(
        a.y * b.z - a.z * b.y,
        a.z * b.x - a.x * b.z,
        a.x * b.y - a.y * b.x
    );
}

// kernelä¸­ä½¿ç”¨
__global__ void kernel(float3* vectors, float* results, int n) {
    int idx = blockIdx.x * blockDim.x + threadIdx.x;
    if (idx < n) {
        results[idx] = dot(vectors[idx], vectors[idx]);  // å†…è”ï¼Œæ— è°ƒç”¨å¼€é”€
    }
}
```

---

### CUDAä¸­çš„é€‰æ‹©æŒ‡å—

| åœºæ™¯ | é€‰æ‹© | åŸå›  |
|------|------|------|
| é”™è¯¯æ£€æŸ¥ | **å®** | éœ€è¦ `__FILE__`ã€`__LINE__` å®šä½è°ƒç”¨ç‚¹ |
| æ¡ä»¶ç¼–è¯‘ | **å®** | `#ifdef` å¯ä»¥å®Œå…¨ç§»é™¤ä»£ç  |
| å­—ç¬¦ä¸²åŒ– | **å®** | `#call` å¯ä»¥æ‰“å°è°ƒç”¨ä»£ç  |
| å¸¸é‡å®šä¹‰ | **å®** | `#define WARP_SIZE 32` |
| æ•°å­¦è®¡ç®— | **å†…è”** | ç±»å‹å®‰å…¨ï¼Œå¯è°ƒè¯• |
| å‘é‡è¿ç®— | **å†…è”** | å¤æ‚é€»è¾‘éœ€è¦ç±»å‹æ£€æŸ¥ |
| é€šç”¨å‡½æ•° | **æ¨¡æ¿+å†…è”** | æ³›å‹ä¸”ç±»å‹å®‰å…¨ |

---

## æ€»ç»“

### ä¸€å¥è¯åŒºåˆ†

- **å®** = é¢„å¤„ç†å™¨çš„**ç›²ç›®æ–‡æœ¬æ›¿æ¢**ï¼ˆä¸æ‡‚ä»£ç ï¼‰
- **å†…è”** = ç¼–è¯‘å™¨çš„**æ™ºèƒ½ä»£ç æ’å…¥**ï¼ˆç†è§£è¯­ä¹‰ï¼‰

### ä½•æ—¶ç”¨å®ï¼Ÿ

1. âœ… éœ€è¦ `__FILE__`ã€`__LINE__` è·å–è°ƒç”¨ç‚¹ä¿¡æ¯
2. âœ… éœ€è¦å­—ç¬¦ä¸²åŒ– `#x`
3. âœ… éœ€è¦æ¡ä»¶ç¼–è¯‘
4. âœ… ç®€å•å¸¸é‡å®šä¹‰

### ä½•æ—¶ç”¨å†…è”ï¼Ÿ

1. âœ… éœ€è¦ç±»å‹å®‰å…¨
2. âœ… æœ‰å‰¯ä½œç”¨çš„å‚æ•°ï¼ˆå¦‚ `i++`ï¼‰
3. âœ… éœ€è¦è°ƒè¯•
4. âœ… æ€§èƒ½å…³é”®çš„å°å‡½æ•°

> [!TIP]
> **ç°ä»£C++å»ºè®®**ï¼šä¼˜å…ˆä½¿ç”¨å†…è”å‡½æ•°ï¼Œé™¤éæœ‰å®çš„ç‹¬ç‰¹éœ€æ±‚ï¼ˆå¦‚ `__FILE__`/`__LINE__`ï¼‰ã€‚
